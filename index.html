<!--

▄▄▄▄▄▄▄▄▄        █              █   ██▀█
██  █   █ ■ ▄▄▄▄ █▄▄▄ ▄▄▄▄ ▄▄▄▄ █   ██▄█  ▄▄▄ ▄▄▄▄ ▄  ▄ ▄▄▄▄
██  █   █ █ ██   ██ █ ▄▄▄█ ██▄█ ██  ██ ██ ██  ▄▄▄█ ██ █ ██ █
██  █   █ █ ██▄▄ ██ █ ██▄█ ██▄▄ ██  ██▄██ ██  ██▄█  ██  ██▄█

-->


<!DOCTYPE html>
<html>

  <head>

    <meta charset="UTF-8">

    <title>Showboat MP3 Player</title>

    <link rel="stylesheet" type="text/css" href="assets/css/style.css">

    <script src="assets/js/three.min.js"></script>

  </head>

  <body>

    <audio id="player" controls="true">
      <source type="audio/mp3">
    </audio>

    <div id="audioplayer" class="hidden">
      <button id="pBack" class="button back" onclick="playBack()" title="Back"></button>
      <button id="pPlay" class="button play" onclick="playAudio()" title="Play"></button>
      <button id="pForward" class="button forward" onclick="playForward()" title="Forward"></button>
    	<div id="timeline" class="button">
    		<div id="playhead"></div>
    	</div>
      <button id="pShuffle" class="button shuffle" onclick="playShuffle()" title="Shuffle"></button>
    </div>

    <script>

    const { remote } = require( 'electron' ),
          { Menu, MenuItem, BrowserWindow, dialog } = remote,
          fs = require( 'fs' ),
          path = require( 'path' )

      var mp3 = [],
          dir = [],
          objects = [],
          totalElements = [],
          totalLength = 0,
          side = 0,
          config,
          files,
          container,
          pressed,
          camera,
          scene,
          renderer,
          raycaster,
          mouse,
          moved,
          group,
          duration,
          timer,
          overPlayer,
          selected,
          current,
          groupReference = new THREE.Vector2( 0, 0 )

      if ( remote.getGlobal( 'config' ) ) {

        try {

          files = fs.readdirSync( remote.getGlobal( 'config' ).musicPath )

        } catch ( err ) {

          console.log( "error reading directory " + remote.getGlobal( 'config' ).musicPath )

        }

        if ( files ) {

          dir.push( "Parent.par" )

          files.forEach( ( file ) => {

            var stats = fs.statSync( path.format( { dir: remote.getGlobal( 'config' ).musicPath, base: file } ) )
            if ( stats.isDirectory() ) { dir.push( file + ".dir" ) }
            if ( file.slice( - 3 ) == 'mp3' ) { mp3.push( file ) }

          } )

          totalElements = dir.concat(mp3)
          totalLength = totalElements.length
          side = Math.cbrt(totalLength)

          if ( mp3.length > 0 ) {

            if ( remote.getGlobal( 'config' ).shuffle ) {

              current = dir.length + Math.floor( Math.random() * mp3.length )

              setSource()

            } else {

              current = dir.length

              setSource()

            }
          }

        }

        if ( remote.getGlobal( 'config' ).shuffle ) {

          pShuffle.className = ""
          pShuffle.className = "button sequential"
          pShuffle.title = "Sequential Play"

        }

      }

      audioplayer.addEventListener( "mouseover", () => { overPlayer = true }, false)
      audioplayer.addEventListener( "mouseout", () => { overPlayer = false }, false)
      player.addEventListener( "ended", playForward, false )
      player.addEventListener( "timeupdate", timeUpdate, false )
      player.addEventListener( "canplaythrough", () => { duration = player.duration }, false )
      timeline.addEventListener( "click", ( event ) => {
        moveplayhead( event )
        if ( player.currentTime ) {	player.currentTime = duration * clickPercent( event ) }
      }, false )

      var ctx = new AudioContext(),
          audioSrc = ctx.createMediaElementSource( player ),
          analyser = ctx.createAnalyser()
      audioSrc.connect( analyser )
      audioSrc.connect( ctx.destination )
      var frequencyData = new Uint8Array( analyser.frequencyBinCount )
      analyser.getByteFrequencyData( frequencyData )

      if ( totalLength < 100 ) {
        var spacing = 27
      } else if ( totalLength < 1000 ) {
        var spacing = 30
      } else {
        var spacing = 50
      }

      init()
      animate()

      var i = 0
      for ( var iz = 0; iz > -side; iz -- ) {
        for ( var iy = 0; iy > -side; iy -- ) {
            for ( var ix = 0; ix < side; ix ++ ) {

            if ( i < totalLength ) {
              addText( totalElements[ i ], i, ix * spacing, iy * spacing, iz * spacing )
            }

            i ++

          }
        }
      }


      //---------------------------------------------------------

      var fullscreen = false, selectPath
      const menu = new Menu()
      menu.append( new MenuItem( {
        label: 'Select Music Folder',
        click() {
          remote.getGlobal( 'config' ).musicPath = dialog.showOpenDialog( BrowserWindow.getFocusedWindow(), {
              properties: [ 'openDirectory' ]
          })[0]
          if ( remote.getGlobal( 'config' ).musicPath ) {
            remote.getCurrentWindow().reload()
          }
        }
      } ) )
      menu.append( new MenuItem( {type: 'separator'} ) )
      menu.append( new MenuItem( {
        label: 'Fullscreen',
        type: 'checkbox',
        checked: false,
        click() {
          if ( fullscreen == false ) {
            BrowserWindow.getFocusedWindow().setFullScreen( true )
            fullscreen = true }
          else {
            BrowserWindow.getFocusedWindow().setFullScreen( false )
            fullscreen = false }
        }
      }))

      window.addEventListener( 'contextmenu', ( event ) => {
        event.preventDefault()
        menu.popup( remote.getCurrentWindow() )
      }, false )

      //---------------------------------------------------------

      function init() {

      	container = document.createElement( 'div' )
      	document.body.appendChild( container )

      	camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 10000 )
      	camera.position.set( 0, 0, 25 )

        camera.lookAt( new THREE.Vector3( 0, 0, 0 ) )

        //---------------------------------------------------------

      	scene = new THREE.Scene()
        group = new THREE.Object3D()
        scene.add( group )

        //---------------------------------------------------------

      	raycaster = new THREE.Raycaster()
      	mouse = new THREE.Vector2()

        renderer = new THREE.WebGLRenderer()
      	renderer.setClearColor( 0x000000 )
      	renderer.setPixelRatio( window.devicePixelRatio )
      	renderer.setSize( window.innerWidth, window.innerHeight )
      	container.appendChild( renderer.domElement )

        document.addEventListener( 'mousedown', onDocumentMouseDown, false )
        document.addEventListener( 'mouseup', onDocumentMouseUp, false )
        document.addEventListener( 'wheel', onDocumentWheel, {passive: true} )
      	document.addEventListener( 'touchstart', onDocumentTouchStart, false )
        document.addEventListener( 'mousemove', onDocumentMouseMove, false )

      	window.addEventListener( 'resize', onWindowResize, false )

      }

      //---------------------------------------------------------

      function addText( name, number, x, y, z ) {

        var elementName = name.substring( 0, name.length - 4 )
        var canvas = document.createElement( 'canvas' )
        var context = canvas.getContext( '2d' )
        var metrics = context.measureText( elementName )

        context.strokeStyle = "rgba( 1, 95, 95, 1 )"
        context.fillStyle = "rgba( 1, 95, 95, .4 )"
        roundRect( context, 0, 5, 300, 80, 20 )
        context.font = "20px Helvetica"
        context.fillStyle = "rgba( 255, 255, 255, 0.95 )"

        if ( metrics.width < 150 ) {
          context.fillText( elementName, 150 - metrics.width, 50 )
        } else {
          context.fillText( elementName, 0, 50 )
        }

        var texture = new THREE.Texture( canvas )
        texture.needsUpdate = true
        texture.minFilter = THREE.LinearFilter
      	var spriteMaterial = new THREE.SpriteMaterial(
      		{ map: texture } )
      	var sprite = new THREE.Sprite( spriteMaterial )

        sprite.position.set( x, y, z )
      	sprite.scale.set( 25, 20, 1.0 )
        sprite.number = number
      	group.add( sprite )
        objects.push( sprite )

      }

      //---------------------------------------------------------

      function roundRect( ctx, x, y, w, h, r ) {

        ctx.beginPath()
        ctx.moveTo( x + r, y )
        ctx.lineTo( x + w - r, y)
        ctx.quadraticCurveTo( x + w, y, x + w, y + r )
        ctx.lineTo( x + w, y + h - r )
        ctx.quadraticCurveTo( x + w, y + h, x + w - r, y + h )
        ctx.lineTo( x + r, y + h )
        ctx.quadraticCurveTo( x, y + h, x, y + h - r )
        ctx.lineTo( x, y + r )
        ctx.quadraticCurveTo( x, y, x + r, y )
        ctx.closePath()
        ctx.fill()
        ctx.stroke()

      }

      //---------------------------------------------------------

      function onWindowResize() {

      	camera.aspect = window.innerWidth / window.innerHeight
      	camera.updateProjectionMatrix()
      	renderer.setSize( window.innerWidth, window.innerHeight )

      }

      //---------------------------------------------------------

      function onDocumentTouchStart( event ) {

      	event.preventDefault()

      	event.clientX = event.touches[0].clientX
      	event.clientY = event.touches[0].clientY

      	onDocumentMouseDown( event )

      }

      //---------------------------------------------------------

      function onDocumentMouseDown( event ) {

        pressed = true
        moved = false

        groupReference.x = event.clientX
        groupReference.y = event.clientY
      }

      //---------------------------------------------------------

      function onDocumentMouseUp( event ) {

        pressed = false

        if ( !moved && !overPlayer ) {

          if ( totalElements[ selected ].slice( - 3 ) == 'par' ) {

            remote.getGlobal( 'config' ).musicPath = path.resolve( remote.getGlobal( 'config' ).musicPath, '..')

            remote.getCurrentWindow().reload()

          }

          else if ( totalElements[ selected ].slice( - 3 ) == 'dir' ) {

            remote.getGlobal( 'config' ).musicPath = path.resolve( remote.getGlobal( 'config' ).musicPath, totalElements[ selected ].substring( 0, totalElements[ selected ].length - 4 ))

            remote.getCurrentWindow().reload()

          } else {

            current = selected

            setSource()

            playAudio()

          }

          // objects.forEach( ( object ) => {
          //   object.visible = false
          // })

      	}

      }

      //---------------------------------------------------------

      function onDocumentMouseMove( event ) {

        clearTimeout( timer )
        audioplayer.className = "visible"

        if ( !overPlayer ) {

          mouse.x = ( event.clientX / renderer.domElement.clientWidth ) * 2 - 1
        	mouse.y = - ( event.clientY / renderer.domElement.clientHeight ) * 2 + 1

        	raycaster.setFromCamera( mouse, camera )

        	var intersects = raycaster.intersectObjects( objects )

        	if ( intersects.length > 0 ) {

            for ( var i = 0; i < objects.length; i ++ ) {
              if ( intersects[ 0 ].object == objects[ i ] ) {
                intersects[ 0 ].object.material.color.set( 0x777777 )
                selected = intersects[ 0 ].object.number
              } else {
                objects[ i ].material.color.set( 0xffffff )
              }
            }

          }

          moved = true

          if ( pressed ) {

            group.position.x -= groupReference.x - event.clientX
            group.position.y += groupReference.y - event.clientY

            groupReference.x = event.clientX
            groupReference.y = event.clientY

            if ( group.position.y < 0 ) {
              group.position.y = 0
            }

            if ( group.position.y > side * spacing ) {
              group.position.y = side * spacing
            }

            if ( group.position.x > 0 ) {
              group.position.x = 0
            }

            if ( group.position.x < - side * spacing ) {
              group.position.x = - side * spacing
            }

          }

          timer = setTimeout( hidePlayer, 3000 )

        }

      }

      //---------------------------------------------------------

      function onDocumentWheel( event ) {

        if ( event.deltaY < 0 && group.position.z < - objects[ objects.length - 1 ].position.z ) {
          group.position.z += spacing
        } else if ( group.position.z > 0 ) {
          group.position.z -= spacing
        }

      }

      //---------------------------------------------------------

      function hidePlayer() {

        audioplayer.className = "hidden"

      }

      //---------------------------------------------------------

      function playBack() {

        if ( current > dir.length ) { current -- }
        else { current = totalLength - 1 }

        setSource()

        playAudio()

      }

      //---------------------------------------------------------

      function playForward() {

        if ( remote.getGlobal( 'config' ).shuffle ) {

          current = dir.length + Math.floor( Math.random() * mp3.length )

        } else {

          if ( current < totalLength - 1 ) { current ++ }
          else { current = dir.length }

        }

        setSource()

        playAudio()

      }

      //---------------------------------------------------------

      function playAudio() {

        if ( player.paused ) {
      		player.play()
      		pPlay.className = ""
      		pPlay.className = "button pause"
          pPlay.title = "Pause"
      	} else {
      		player.pause()
      		pPlay.className = ""
      		pPlay.className = "button play"
          pPlay.title = "Play"
      	}

      }

      //---------------------------------------------------------

      function playShuffle() {

      	if ( remote.getGlobal( 'config' ).shuffle ) {
          remote.getGlobal( 'config' ).shuffle = false
      		pShuffle.className = ""
      		pShuffle.className = "button shuffle"
          pShuffle.title = "Shuffle"
      	} else {
          remote.getGlobal( 'config' ).shuffle  = true
      		pShuffle.className = ""
      		pShuffle.className = "button sequential"
          pShuffle.title = "Sequential Play"
      	}

      }

      //---------------------------------------------------------

      function timeUpdate() {

      	var playPercent = 100 * ( player.currentTime / duration )
      	playhead.style.marginLeft = playPercent + "%"

      }

      //---------------------------------------------------------

      function clickPercent( event ) {

      	return ( event.pageX - timeline.offsetLeft ) / timeline.offsetWidth

      }

      //---------------------------------------------------------

      function moveplayhead( event ) {

      	var newMargLeft = event.pageX - timeline.offsetLeft

      	if ( newMargLeft == 0 && newMargLeft == timeline.offsetWidth ) {
      		playhead.style.marginLeft = newMargLeft + "px"
      	}

      	if ( newMargLeft == 0 ) {
      		playhead.style.marginLeft = "0px"
      	}

      	if ( newMargLeft == timeline.offsetWidth ) {
      		playhead.style.marginLeft = timeline.offsetWidth + "px";
      	}

      }

      //---------------------------------------------------------

      function setSource() {

        player.src = path.format( {
          dir: remote.getGlobal( 'config' ).musicPath,
          base: totalElements[ current ]
        })

      }

      //---------------------------------------------------------

      function animate() {

      	requestAnimationFrame( animate )

      	renderer.render( scene, camera )

      	// render()

      }

      //---------------------------------------------------------

      function render() {

        analyser.getByteFrequencyData(frequencyData)

        var i = 0, f = 0
        for ( var k = 0; k < objects.length; k ++ ) {
          f = frequencyData[ i ] / 255.0
          objects[ k ].material.color.setRGB( 1-f, 1-f, 1-f )
          if ( i < 1000 ) { i ++  }
          else { i = 0 }
        }

      	renderer.render( scene, camera )

      }

    </script>

  </body>

  <script>

    require( './renderer.js' )

  </script>

</html>
